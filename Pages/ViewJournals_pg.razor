@page "/viewjournals_pg"
@inject HttpClient Http
@inject ITrHeadService myTrHeadService
@inject ITrDetailService myTrDetailService
@inject AccYear myAccYear

@using DigiEquipSys.Services
@using DigiEquipSys.Models
@using DigiEquipSys.Interfaces

@inject IvwTransferService myvwTransferService

@inject NavigationManager UriHelper
@using System.Dynamic
@inject ISessionStorageService sessionStorage
@inject IJSRuntime JSRuntime
@using System.Collections.Generic

<h3 class="page-title">Journal Summary</h3>




<style>
    .highlight-row {
        background-color: yellow !important;
        color: green !important;
    }

    .highlight-up {
        background-color: cyan !important;
        color: green !important;
    }

        .highlight-row:hover {
            background-color: #FFFACD !important; /* same as normal state */
</style>
<style>
    .e-grid .e-headercelldiv {
        font-weight: bold !important;
        background-color: #604B7C;
        color: white
    }

    .e-grid .e-groupheadercell {
        height: 30px;
        background: linear-gradient();
        color: #fff;
    }

        .e-grid .e-groupheadercell:hover {
            height: 30px;
            background: #ffbb60;
            color: #fff;
        }
</style>
<style>
    .e-spinner-pane .e-spinner-inner .e-spin-Bootstrap5 {
        stroke: red;
    }

    .Control-wrapper {
        width: 250px;
    }

    .myButton {
        background-color: #0a0a23;
        color: white;
        border: 2px solid #E9E9E9;
        border-width: 2px 2px 2px 2px;
        border-radius: 10px;
        padding: 15px;
        min-height: 30px;
        min-width: 120px;
    }

        .myButton:hover {
            background-color: #002ead;
            transition: 0.7s;
        }

</style>
<SfSpinner @bind-Visible="@SpinnerVisible" Type="@SpinnerType.Bootstrap5" Size="50">
</SfSpinner>

@if (@TransferList != null)
{
    <div class="col-lg-12 Control-section">
        <div class="content-wrapper">
            <div class="row">
                <div class="Control-wrapper">
                    <SfDateRangePicker TValue="DateTime?" Placeholder="Choose a Date Range" FullScreen="true" ShowClearButton="true" @bind-StartDate="@selectedRange.selectedRangeFrom"
                                       @bind-EndDate="@selectedRange.selectedRangeTo">                        
                        <DateRangePickerEvents TValue="DateTime?" ValueChange="ValueChangeHandler"></DateRangePickerEvents>
                    </SfDateRangePicker>
                </div>
                <div class="Control-wrapper">
                    <SfButton @onclick="OnlyActionTrue">Reversible</SfButton>
                </div>
                <br />
                <div id="container">
                    <SfGrid @ref="TransferGrid" Height="550px" Width="100%" 
                            DataSource="@TransferList" AllowTextWrap="true"
                            AllowGrouping="false" AllowSorting="true" AllowFiltering="true" AllowPaging="true" AllowResizing="true" AllowReordering="true" AllowExcelExport="true"
                            ContextMenuItems="@(new List<object>() {"AutoFit", "AutoFitAll", "SortAscending", "SortDescending","Copy", "ExcelExport","CsvExport", "FirstPage", "PrevPage","LastPage", "NextPage"})"
                            Toolbar="@(new List<string>() { "Print", "ExcelExport" })">
                        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.CheckBox"></GridFilterSettings>
                        <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false" Mode="EditMode.Normal"></GridEditSettings>
                        <GridEvents RowDataBound="OnRowDataBound" TValue="VwTransfer" OnToolbarClick="ToolbarClickHandler" OnActionBegin="ActionBeginHandler"></GridEvents>
                        <GridPageSettings PageSize="20" PageSizes="@(new int[] {20, 30, 50, 100, 200, 400,500})"></GridPageSettings>
                        <GridTemplates>
                            <EmptyRecordTemplate>
                                <span>No Records Found</span>
                            </EmptyRecordTemplate>
                        </GridTemplates>

                        <GridAggregates>
                            <GridAggregate>
                                <GridAggregateColumns>

                                    <GridAggregateColumn Field="AlertAmt" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);

                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn>

                                    <GridAggregateColumn Field="NonAlertAmt" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);

                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn>

                                    <GridAggregateColumn Field="QtyFrom" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);

                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn>

                                    <GridAggregateColumn Field="RevAmt" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);

                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn>

                                    @* <GridAggregateColumn Field="DiffAmt" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);

                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn>

                                    <GridAggregateColumn Field="AmtFrom" Type="AggregateType.Sum" Format="n2">
                                        <FooterTemplate Context="vMyContext">
                                            @{
                                                var vMyaggregate = (vMyContext as AggregateTemplateContext);
                                                <div>
                                                    <p>@vMyaggregate.Sum</p>
                                                </div>
                                            }
                                        </FooterTemplate>
                                    </GridAggregateColumn> *@


                                </GridAggregateColumns>
                            </GridAggregate>
                        </GridAggregates>

                        <GridColumns>
                            <GridColumn Field="@nameof(VwTransfer.TrhDispNo)"
                                        HeaderText="Journal No."
                                        AllowEditing="false"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrhDate)" Format="dd/MM/yyyy"
                                        HeaderText="Journal Date"
                                        AllowEditing="false"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrhApproved)"
                                        HeaderText="Approved"
                                        AllowEditing="false" Visible="false"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrdListNo)"
                                        HeaderText="List No."
                                        AllowEditing="false"
                                        Width="25">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.TrdLotNo)"
                                        HeaderText="Lot No."
                                        AllowEditing="false"
                                        Width="25">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.TrdExpiryDate)" Format="dd/MM/yyyy"
                                        HeaderText="Exp. Date"
                                        AllowEditing="false"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.ItemDesc)"
                                        HeaderText="Item Desc"
                                        AllowEditing="false"
                                        Width="40">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.GrpDesc)"
                                        HeaderText="Group"
                                        AllowEditing="false"
                                        Width="30">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.CatDesc)"
                                        HeaderText="Category"
                                        Width="30"
                                        AllowEditing="false">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.ItemUnit)"
                                        HeaderText="Unit"
                                        Width="20"
                                        AllowEditing="false">
                            </GridColumn>

                            <GridColumn Field=@nameof(VwTransfer.ClientFrom)
                                        HeaderText="Transfer From" Width="30"
                                        AllowEditing="false">
                            </GridColumn>
                            <GridColumn Field=@nameof(VwTransfer.ClientTo)
                                        HeaderText="Transfer To" Width="30"
                                        AllowEditing="false">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrdClientCodeFromUp)" Format="n2" Visible="@IsVisRole"
                                        HeaderText="From Purch.Price"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrdClientCodeToUp)" Format="n2" Visible="@IsVisRole"
                                        HeaderText="To Purch.Price"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="30">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.DiffPurchPrice)" Format="n2" Visible="@(myRole == "01")"
                                        HeaderText="Diff."
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="20">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.TrdAlert)" Format="n2" Visible="@IsVisRole"
                                        HeaderText="Alert"
                                        AllowEditing="false"
                                        AllowFiltering=true
                                        TextAlign="TextAlign.Center"
                                        Width="25">
                            </GridColumn>

                           @* <GridColumn HeaderText="Action" TextAlign="TextAlign.Center" Width="20">
                                <Template>
                                    @{
                                        var data = context as VwTransfer;
                                        if ((data.TrdAlert ?? false) && data.TrdAlertStop==false && (data.TrdLotChange ==null || data.TrdLotChange==""))
                                        {
                                            <SfButton CssClass="e-icons e-view-details" Style="background-color: #fff; color: #000; border-block-color;" @onclick="() => OnButtonClick(data)">Action</SfButton>
                                        }
                                    }
                                </Template>
                            </GridColumn> *@
                            <GridColumn Field="@nameof(VwTransfer.TrdAction)"  HeaderText="Action" AllowEditing="false" AllowFiltering=true TextAlign ="TextAlign.Center" Width="20">
                                <Template>
                                    @{
                                        var data1 = context as VwTransfer;
                                        //bool isVisible = (data1.TrdAlert == "true"); visibility:{(isVisible ? "visible" : "hidden")};
                                        @if (data1.TrdAction == true)
                                        {
                                            <SfButton CssClass = "e-icons e-view-details" Style = "background-color: #fff; color: #000; border-block-color;" @onclick = "() => OnButtonClick(data1)" > Action </SfButton >
                                        }
                                    }
                                </Template>
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrdLotChange)"
                                        HeaderText="LotChange"
                                        AllowEditing="false"
                                        AllowFiltering=true
                                        TextAlign="TextAlign.Center"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.TrdReversal)" 
                                        HeaderText="Reversal" 
                                        AllowEditing="false" 
                                        AllowFiltering=true 
                                        TextAlign="TextAlign.Center" 
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.OrderQty)" Visible="true"
                                        HeaderText="Order Qty"
                                        AllowEditing="false"
                                        AllowFiltering=true
                                        TextAlign="TextAlign.Right"
                                        Width="30">
                            </GridColumn>


                            <GridColumn Field="@nameof(VwTransfer.QtyFrom)" Visible="true"
                                        HeaderText="Journal Qty"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="30">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.AmtFrom)" Format="n2" Visible="false"
                                        HeaderText="Journal Amount"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="40">
                            </GridColumn>

                            <GridColumn Field="@nameof(VwTransfer.AlertAmt)" Format="n2" Visible="@(myRole == "01")"
                                        HeaderText="Alert Amount Diff"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="40">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.NonAlertAmt)" Format="n2" Visible="@(myRole == "01")"
                                        HeaderText="Non Alert Amount Diff"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="50">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.DiffAmt)" Format="0.00" Visible="false"
                                        HeaderText="Diff Amount"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="40">
                            </GridColumn>
                            <GridColumn Field="@nameof(VwTransfer.RevAmt)" Format="0.00" Visible="true"
                                        HeaderText="Reversal Amount"
                                        AllowEditing="false"
                                        AllowFiltering=false
                                        TextAlign="TextAlign.Right"
                                        Width="40">
                            </GridColumn>

                        </GridColumns>
                    </SfGrid>
                </div>
                <br />
            </div>

           @*  <button class="btn btn-primary" @onclick="OpenDialog">Show List</button> *@

            <SfDialog @bind-Visible="IsDialogVisible" Width="300px" Header="Items List">
                <ul>
                    @foreach (var item in Items)
                    {
                        <li>
                            <a href="#" @onclick="() => NavigateToItem(item)"> @item </a>
                        </li>
                    }
                </ul>
                <SfButton @onclick="CloseDialog">Close</SfButton>
            </SfDialog>




            @*<SfDialog Width="600" @bind-Visible="@IsVisible" ShowCloseIcon="true" IsModal="false" Target="#TransferGrid">
                <DialogTemplates>
                    <Header>Journal Reverse</Header>
                    <Content>
                        @{
                            <EditForm Model="@trvouaddedita">

                                 <div class="grid-container">
                                     <div class="grid-item">
                                         <SfTextBox Enabled="false" Placeholder="Journal No" @bind-Value="@trvouaddedita.TrhDispNo" Syncfusion.Blazor.Inputs.FloatLabelType="Syncfusion.Blazor.Inputs.FloatLabelType.Always"></SfTextBox>
                                     </div>
                                     <div class="grid-item">
                                         <SfDatePicker Enabled=@vEnable TValue="DateTime?" Placeholder="Journal Date" @bind-Value="@trvouaddedita.TrhDate" Syncfusion.Blazor.Inputs.FloatLabelType="Syncfusion.Blazor.Inputs.FloatLabelType.Auto">
                                         <DatePickerEvents TValue="DateTime?" ValueChange="NoToFutureDate"></DatePickerEvents>
                                         </SfDatePicker>
                                     </div>
                                    <div class="grid-item">
                                        <SfTextBox Enabled=@vEnable Placeholder="Remarks" @bind-Value="@trvouaddedita.TrhRemarks" Syncfusion.Blazor.Inputs.FloatLabelType="Syncfusion.Blazor.Inputs.FloatLabelType.Always"></SfTextBox>
                                    </div>
                                 </div>
                            </EditForm>
                        }
                    </Content>
                </DialogTemplates>
            </SfDialog>*@

            <WarningPage @ref="Warning" WarningHeaderMessage="@WarningHeaderMessage" WarningContentMessage="@WarningContentMessage" />
            <a href="#" @onclick="NavigateToPrevious" CssClass="e-link">
                <SfButton CssClass="e-small e-success">BACK</SfButton>
            </a>
            <button type="button" class="e-btn e-normal" @onclick="GotoStkJournal">Go to Journal Entry</button>
            <span style="font-weight:600;text-align:right;visibility:@(myRole == "01" ? "visible" : "hidden")">Total Quantities: @TotalQty </span>
            <span style="font-weight:600;text-align:right;visibility:@(myRole == "01" ? "visible" : "hidden")">Total Amount: @TotalAmt.ToString("N2") </span>
        </div>
    </div>

}